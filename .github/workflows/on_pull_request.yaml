name: On pull request

on:
  pull_request:
    types: [ opened, reopened, synchronize ]

jobs:
  web_test:
    runs-on: ubuntu-latest
    env:
      # ---------- ENDPOINT
      BASE_API_URL: ${{ vars.BASE_API_URL }}
      BASE_URL: ${{ vars.BASE_URL }}
      GH_API_URL: ${{ github.api_url }}
      # ---------- COMMON
      API_LOG_LVL: ${{ vars.API_LOG_LVL }}
      ENV: ci
      LOG_LVL: ${{ vars.LOG_LVL }}
      PYTEST_ARGS: ${{ vars.PYTEST_ARGS_WEB }}
      PYTEST_MARK_EXPR: ${{ vars.PYTEST_MARK_EXPR_NOT_SCREENSHOT }}
      # ---------- API
      DEFAULT_USER_AGENT: ${{ vars.DEFAULT_USER_AGENT }}
      HTTP_TIMEOUT: ${{ vars.HTTP_TIMEOUT }}
      # ---------- UI
      ALLURE_ATTACH_TEST_ARTIFACTS: ${{ vars.ALLURE_ATTACH_TEST_ARTIFACTS }}
      ALLURE_ATTACH_TEST_VIDEO: ${{ vars.ALLURE_ATTACH_TEST_VIDEO }}
      BROWSER_NAME: ${{ vars.BROWSER_NAME }}
      BROWSER_VERSION: ${{ vars.BROWSER_VERSION }}
      BROWSER_SIZE: ${{ vars.BROWSER_SIZE }}
      BROWSER_HEADLESS: ${{ vars.BROWSER_HEADLESS }}
      BROWSER_TIMEOUT: ${{ vars.BROWSER_TIMEOUT }}
      BROWSER_SCRIPTS_TIMEOUT: ${{ vars.BROWSER_SCRIPTS_TIMEOUT }}
      BROWSER_PAGE_LOAD_STRATEGY: eager
      BROWSER_PAGE_LOAD_TIMEOUT: ${{ vars.BROWSER_PAGE_LOAD_TIMEOUT }}
      BROWSER_DOWNLOAD_DIR: ${{ vars.BROWSER_DOWNLOAD_DIR }}
      BROWSER_REMOTE_VNC: ${{ vars.BROWSER_REMOTE_VNC }}
      BROWSER_REMOTE_VIDEO: ${{ vars.BROWSER_REMOTE_VIDEO }}
      BROWSER_REMOTE_LOGS: ${{ vars.BROWSER_REMOTE_LOGS }}
      BROWSER_REMOTE_AUDIO: ${{ vars.BROWSER_REMOTE_AUDIO }}
      BROWSER_REMOTE_SESSION_TIMEOUT: ${{ vars.BROWSER_REMOTE_SESSION_TIMEOUT }}
      DEFAULT_PERCENT_OF_TOLERANCE: ${{ vars.DEFAULT_PERCENT_OF_TOLERANCE }}
      DEFAULT_SCREENSHOT_TIMEOUT: ${{ vars.DEFAULT_SCREENSHOT_TIMEOUT }}
      PATH_TO_FILES: ${{ vars.PATH_TO_FILES }}
      REMOTE_TYPE: ${{ vars.REMOTE_TYPE }}
      REMOTE_URL: ${{ vars.REMOTE_URL }}
      REWRITE_ALL_SCREENSHOTS: false
      # ---------- GITHUB
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
      GH_TOKEN_NAME: ${{ vars.GH_TOKEN_NAME }}
      GH_ACCOUNT_NAME: ${{ github.repository_owner }}
      GH_REPO_NAME: ${{ vars.GH_REPO_NAME }}
      # ---------- EXPECTED DATA
      DEFAULT_EMAIL: ${{ secrets.DEFAULT_EMAIL }}
      DEFAULT_PASSWORD: ${{ secrets.DEFAULT_PASSWORD }}
      EMAIL_DOMAIN: ${{ secrets.EMAIL_DOMAIN }}
      EXPECTED_PRODUCT_ID: ${{ vars.EXPECTED_PRODUCT_ID }}
      EXPECTED_PRODUCT_IDS: ${{ vars.EXPECTED_PRODUCT_IDS }}
      EXPECTED_CREDIT_CARD: ${{ vars.EXPECTED_CREDIT_CARD }}
      RECOMMENDED_PRODUCT_IDS: ${{ vars.RECOMMENDED_PRODUCT_IDS }}
      # ---------- OTHER
      ARCH: ${{ vars.ARCH }}
      BUILD_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      PREFIX: ${{ github.repository_owner }}
      PYTHON_VERSION: ${{ vars.PYTHON_VERSION }}
      SHOW_LOGS: ${{ vars.SHOW_TEST_CONTAINER_LOGS }}
      EXPECTED_TESTS_PASSED_RATE: ${{ vars.EXPECTED_TESTS_PASSED_RATE }}
      WORKFLOW_REPORT_ID: on_pull_request

    steps:

      - name: Get current date/time
        run: |
          echo "CURRENT_DATE_TIME=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ env.GITHUB_SHA }}

      - name: Get the last commit message
        run: |
          echo "HEAD_COMMIT_MESSAGE=$(git show -s --format=%s)" >> $GITHUB_ENV

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: "${{ env.PYTHON_VERSION }}"

      - name: Pull browser image
        uses: ./.github/actions/pull-browser
        with:
          browser: ${{ env.BROWSER_NAME }}
          version: ${{ env.BROWSER_VERSION }}
          enable_video: ${{ env.BROWSER_REMOTE_VIDEO }}

      - name: Checkout workflow-resources branch
        uses: actions/checkout@v4
        with:
          ref: workflow-resources
          path: workflow-resources

      - name: Prepare workflow-resources directory
        run: |
          set -e
          mkdir -p workflow-resources/screenshot

      - name: Run API + WEB tests
        uses: ./.github/actions/run-tests
        if: always()
        continue-on-error: true

      - name: Update env variables for SCREENSHOT test run
        if: always()
        run: |
          echo "PYTEST_MARK_EXPR=${{ vars.PYTEST_MARK_EXPR_SCREENSHOT }}" >> $GITHUB_ENV
          echo "PYTEST_ARGS=${{ vars.PYTEST_ARGS_SCREENSHOT }}" >> $GITHUB_ENV
          echo "PAGE_LOAD_STRATEGY=normal" >> $GITHUB_ENV

      - name: Run SCREENSHOT tests
        uses: ./.github/actions/run-tests
        if: always()
        with:
          remove_compose_data: true
        continue-on-error: true

      - name: Get Allure history
        uses: actions/checkout@v2
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      - name: Allure Report action from marketplace
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          subfolder: '${{ env.WORKFLOW_REPORT_ID }}'
          report_name: Pull Request Report
          allure_results: allure-results
          allure_history: allure-history

      - name: Deploy report to Github Pages
        uses: peaceiris/actions-gh-pages@v4
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: 'gh-pages'
          publish_dir: 'allure-history'

      - name: Parse Test Statistics
        id: stats
        if: always()
        run: |
          sudo apt-get install -y jq bc

          HISTORY_TREND_FILE=$(find / -type f -path "*/last-history/history-trend.json" 2>/dev/null -print -quit)
          
          if [ -f "$HISTORY_TREND_FILE" ]; then

            LATEST_STATS=$(jq '.[0].data // {passed:0, failed:0, broken:0, skipped:0, unknown:0, total:0}' "$HISTORY_TREND_FILE")
          
            PASSED=$(echo "$LATEST_STATS" | jq '.passed')
            FAILED=$(echo "$LATEST_STATS" | jq '.failed')
            BROKEN=$(echo "$LATEST_STATS" | jq '.broken')
            SKIPPED=$(echo "$LATEST_STATS" | jq '.skipped')
            UNKNOWN=$(echo "$LATEST_STATS" | jq '.unknown')
            TOTAL=$(echo "$LATEST_STATS" | jq '.total')
          
          else
          
            echo "WARNING: `*/last-history/history-trend.json` NOT FOUND â†’ assuming no tests or report generation failed"
            echo "### ALL history-trend.json files"
            echo $(find / -type f -name "history-trend.json" 2>/dev/null | head -n 100 || echo "")
          
            PASSED=0
            FAILED=0
            BROKEN=0
            SKIPPED=0
            UNKNOWN=0
            TOTAL=-1
          
          fi

          VALID_TESTS_COUNT=$((PASSED + SKIPPED + UNKNOWN))
          ACTUAL_TESTS_PASS_RATE=$(awk '{printf "%.3f\n", ($1 / $2) * 100}' <<< "$VALID_TESTS_COUNT $TOTAL")

          echo "PASSED=$PASSED" >> $GITHUB_OUTPUT
          echo "FAILED=$FAILED" >> $GITHUB_OUTPUT
          echo "BROKEN=$BROKEN" >> $GITHUB_OUTPUT
          echo "SKIPPED=$SKIPPED" >> $GITHUB_OUTPUT
          echo "UNKNOWN=$UNKNOWN" >> $GITHUB_OUTPUT
          echo "TOTAL=$TOTAL" >> $GITHUB_OUTPUT
          echo "ACTUAL_TESTS_PASS_RATE=$ACTUAL_TESTS_PASS_RATE" >> $GITHUB_OUTPUT

      - name: Quality gate
        id: quality_gate
        if: always()
        run: |

          EXPECTED_PASS_RATE=${{ env.EXPECTED_TESTS_PASSED_RATE }}
          ACTUAL_PASS_RATE=${{steps.stats.outputs.ACTUAL_TESTS_PASS_RATE}}
          IS_PASSED=$(awk -v a="$ACTUAL_PASS_RATE" -v e="$EXPECTED_PASS_RATE" 'BEGIN {print (a >= e ? "true" : "false")}')
          
          if [ "$IS_PASSED" != "true" ]; then
            echo "Quality gate failed: Actual pass rate $ACTUAL_PASS_RATE% < Expected $EXPECTED_PASS_RATE%"
            exit 1
          fi

          echo "Quality gate passed: Actual pass rate $ACTUAL_PASS_RATE% >= Expected $EXPECTED_PASS_RATE%"
          echo "IS_PASSED=$IS_PASSED" >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            
            const isPassed = '${{ steps.quality_gate.outputs.IS_PASSED }}' === 'true';
            const repoName = context.repo.repo
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: repoName,
              issue_number: context.issue.number,
            });
            
            const marker = '<!-- TEST RUN COMMENT -->';
            const message_existing = comments.find(comment => comment.body.includes(marker));
            
            const currentReportUrl = `https://${{ github.repository_owner }}.github.io/${repoName}/${{ env.WORKFLOW_REPORT_ID }}/${{ github.run_number }}/index.html`;
            const reportsUrl = `https://${{ github.repository_owner }}.github.io/${repoName}/${{ env.WORKFLOW_REPORT_ID }}/index.html`;
            
            const statsMessage = `${marker}
            ğŸ“‹ Test Statistics:
            
            | Status | Count |
            |--------|-------|
            | âœ… Passed | ${{ steps.stats.outputs.PASSED }} |
            | ğŸ”´ Failed | ${{ steps.stats.outputs.FAILED }} |
            | ğŸŸ  Broken | ${{ steps.stats.outputs.BROKEN }} |
            | â© Skipped | ${{ steps.stats.outputs.SKIPPED }} |
            | â“ Unknown | ${{ steps.stats.outputs.UNKNOWN }} |
            | ğŸ“Š Total | ${{ steps.stats.outputs.TOTAL }} |
            | ğŸ“ˆ Pass Rate | ${{ steps.stats.outputs.ACTUAL_TESTS_PASS_RATE }}% |
            Current run report: [link](${currentReportUrl})
            ğŸ•“ Current workflow reports history: [link](${reportsUrl})
            `;
          
            const message = isPassed
              ? `âœ… TEST RUN PASSED âœ…\n${statsMessage}\nThere is the [report](${currentReportUrl})\nğŸ•“ All reports [history](${reportsUrl})`
              : `ğŸ”´ TEST RUN FAILED ğŸ”´\n${statsMessage}\nThere is the [report](${currentReportUrl})\nğŸ•“ All reports [history](${reportsUrl})`;
            
            if (message_existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: message_existing.id,
                body: message
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: message
              });
            }